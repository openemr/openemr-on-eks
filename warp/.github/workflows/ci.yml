# =====================================
# Warp Project CI/CD Workflow
# =====================================
# This workflow provides comprehensive testing and validation for the Warp project
# (OpenEMR Data Upload Accelerator). It runs automatically on pushes and pull requests
# to the warp/ directory, and can be manually triggered.
#
# Key Features:
# - Python package testing with pytest and coverage
# - Code quality checks (flake8, black, mypy)
# - Security scanning with Trivy
# - Artifact collection and test result reporting
# - Manual workflow dispatch support
#
# Test Categories:
# 1. Unit Tests: pytest with coverage reporting
# 2. Code Quality: flake8 linting, black formatting, mypy type checking
# 3. Security Scan: Vulnerability scanning with Trivy

name: Warp CI/CD

# Workflow triggers - runs on code changes to warp/ and manual dispatch
on:
  # Automatic triggers on main and develop branches
  push:
    branches: [ main, develop ]
    paths:
      - 'warp/**'
      - 'warp/.github/workflows/ci.yml'
      - 'versions.yaml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'warp/**'
      - 'warp/.github/workflows/ci.yml'
      - 'versions.yaml'
  # Manual trigger
  workflow_dispatch:

# Required permissions for the workflow
permissions:
  contents: read         # Read repository contents for testing
  security-events: write # Write security scan results to GitHub Security tab
  actions: read          # Read workflow information for reporting

# Environment variables for consistent tool versions across all jobs
env:
  PYTHON_VERSION: '3.14.0' # Python version (matches main CI/CD workflow)
  WARP_DIR: 'warp'         # Warp project directory

jobs:
  # Test job - runs pytest with coverage
  test:
    name: Run Tests
    runs-on: ubuntu-24.04

    steps:
      # Step 1: Checkout repository code
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Step 3: Install Python dependencies
      - name: Install dependencies
        run: |
          cd ${{ env.WARP_DIR }}
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
          # Install test dependencies
          # These versions are pinned in versions.yaml
          # If these are changed update versions.yaml and vice-versa
          pip install pytest==9.0.2 pytest-cov==7.0.0

      # Step 4: Run pytest with coverage
      - name: Run pytest with coverage
        run: |
          cd ${{ env.WARP_DIR }}
          pytest tests/ -v --cov=warp --cov-report=term-missing --cov-report=html

      # Step 5: Upload coverage reports as artifacts
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: ${{ env.WARP_DIR }}/htmlcov/
          retention-days: 7

  # Lint and format job - performs code quality checks
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-24.04

    steps:
      # Step 1: Checkout repository code
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Step 3: Install linting and formatting tools
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black mypy

      # Step 4: Run flake8 linting
      - name: Run flake8
        run: |
          cd ${{ env.WARP_DIR }}
          flake8 warp/ --max-line-length=127 --count --statistics

      # Step 5: Check code formatting with black
      - name: Check formatting with black
        run: |
          cd ${{ env.WARP_DIR }}
          black --check warp/ tests/

      # Step 6: Run type checking with mypy
      - name: Run type checking with mypy
        run: |
          cd ${{ env.WARP_DIR }}
          mypy warp/ --ignore-missing-imports || echo "Type checking completed with warnings"

  # Security scanning job - ZERO-TOLERANCE policy for comprehensive security analysis
  security-scan:
    name: Security Scan (Zero-Tolerance)
    runs-on: ubuntu-24.04

    steps:
      # Step 1: Checkout repository code
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      # Step 2: Run Trivy vulnerability scanner (Table format - STRICT MODE)
      - name: Run Trivy vulnerability scanner (Table format - STRICT)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '${{ env.WARP_DIR }}'
          format: 'table'
          output: 'trivy-results.txt'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'  # All severities - zero tolerance
          scanners: 'vuln,secret,config'
          exit-code: '1'                        # FAIL on any finding
          skip-db-update: false
          cache-dir: '.trivycache'
          trivyignores: '.trivyignore'          # Use ignore file for false positives only

      # Step 3: Run Trivy vulnerability scanner (SARIF format)
      - name: Run Trivy vulnerability scanner (SARIF format)
        uses: aquasecurity/trivy-action@master
        if: success()
        with:
          scan-type: 'fs'
          scan-ref: '${{ env.WARP_DIR }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          scanners: 'vuln,secret,config'
          exit-code: '1'                        # FAIL on any finding
          trivyignores: '.trivyignore'

      # Step 4: Display Trivy scan results
      - name: Display Trivy results
        if: always()
        run: |
          echo "üîç Trivy Security Scan Results for Warp (ZERO-TOLERANCE):"
          echo "=========================================================="
          if [ -f "trivy-results.txt" ]; then
            cat trivy-results.txt
          else
            echo "‚úÖ No vulnerabilities found - scan passed"
          fi
          echo "=========================================================="

      # Step 5: Upload SARIF results to GitHub Security tab
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true  # Don't fail if GitHub Advanced Security is not enabled
        with:
          sarif_file: 'trivy-results.sarif'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 6: Security scan enforcement status
      - name: Security scan enforcement status
        if: success()
        run: |
          echo "‚úÖ Security scan PASSED - No findings detected"
          echo "üîí Zero-tolerance policy enforced for Warp"

  # Summary job - generates comprehensive test results summary
  summary:
    name: Test Summary
    runs-on: ubuntu-24.04
    needs: [test, lint-and-format, security-scan]
    if: always()

    steps:
      # Step 1: Checkout repository code
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      # Step 2: Download test artifacts
      - name: Download test artifacts
        uses: actions/download-artifact@v5
        with:
          path: test-results/

      # Step 3: Generate summary report
      - name: Generate summary report
        run: |
          echo "## üß™ Warp CI/CD Test Results Summary"
          echo ""
          echo "### üìä Test Results Overview"
          echo ""
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "‚úÖ **Tests passed successfully!**"
          else
            echo "‚ùå **Tests failed. Please review the logs above.**"
          fi
          echo ""
          if [ "${{ needs.lint-and-format.result }}" == "success" ]; then
            echo "‚úÖ **Linting and formatting checks passed!**"
          else
            echo "‚ùå **Linting or formatting checks failed. Please review the logs above.**"
          fi
          echo ""
          echo "### üîí Security Scan Status (Zero-Tolerance Policy)"
          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "‚úÖ **Security scan PASSED - No findings detected**"
            echo "- Zero-tolerance policy enforced: All severity levels checked (CRITICAL, HIGH, MEDIUM, LOW)"
            echo "- Scanners: Vulnerability, Secret Detection, Configuration"
          else
            echo "‚ùå **Security scan FAILED - Findings detected**"
            echo "- ALL findings must be remediated before merging (zero-tolerance policy)"
            echo "- Check the security-scan job logs for detailed vulnerability results"
          fi
          echo ""
          echo "## üìä Overall Status"
          if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.lint-and-format.result }}" == "success" ]; then
            echo "‚úÖ **All checks passed successfully!**"
          else
            echo "‚ùå **Some checks failed. Please review the logs above.**"
          fi
