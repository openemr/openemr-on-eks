apiVersion: batch/v1
kind: Job
metadata:
  name: warp-ccda-upload
  namespace: openemr
  labels:
    app: warp
    command: ccda-data-upload
spec:
  # Retry policy
  backoffLimit: 2
  ttlSecondsAfterFinished: 3600  # Clean up after 1 hour
  
  template:
    metadata:
      labels:
        app: warp
        command: ccda-data-upload
    spec:
      serviceAccountName: openemr-sa  # Use OpenEMR service account for IRSA
      restartPolicy: Never
      
      containers:
      - name: warp-ccda-upload
        image: openemr/warp:latest  # Update with your image
        imagePullPolicy: Always
        
        # Security context for container hardening
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
          capabilities:
            drop:
            - ALL
        
        env:
        # Database connection (from Kubernetes secrets)
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: openemr-db-credentials
              key: mysql-host
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: openemr-db-credentials
              key: mysql-user
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: openemr-db-credentials
              key: mysql-password
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: openemr-db-credentials
              key: mysql-database
        
        # Data source configuration
        - name: DATA_SOURCE
          value: "s3://synpuf-omop/cmsdesynpuf1k/"  # S3 path to OMOP data
        - name: AWS_REGION
          value: "us-west-2"
        
        # Processing options - optimized for performance
        - name: BATCH_SIZE
          value: "500"  # Larger batches for Kubernetes
        - name: WORKERS
          value: "8"  # Multiple workers for parallel processing
        - name: MAX_RECORDS
          value: ""  # Empty = process all records
        
        # Logging
        - name: LOG_LEVEL
          value: "INFO"
        
        command: ["warp"]
        args:
        - "ccda_data_upload"
        - "--db-host"
        - "$(DB_HOST)"
        - "--db-user"
        - "$(DB_USER)"
        - "--db-password"
        - "$(DB_PASSWORD)"
        - "--db-name"
        - "$(DB_NAME)"
        - "--data-source"
        - "$(DATA_SOURCE)"
        - "--batch-size"
        - "$(BATCH_SIZE)"
        - "--workers"
        - "$(WORKERS)"
        - "--aws-region"
        - "$(AWS_REGION)"
        
        # Generous resources for high performance
        resources:
          requests:
            memory: "8Gi"
            cpu: "4"
          limits:
            memory: "16Gi"
            cpu: "8"
        
        # Volume mounts for temporary data
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        
      volumes:
      - name: tmp
        emptyDir: {}
      
      # Use IRSA for S3 access (if configured)
      # The service account should have S3 read permissions

---
# Note: Database credentials are stored in the 'openemr-db-credentials' secret
# which is created by the main deployment. This job references that secret.
# No separate secret creation needed for warp.
