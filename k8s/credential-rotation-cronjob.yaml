# =============================================================================
# Credential Rotation CronJob
# =============================================================================
# Scheduled credential rotation running monthly at 03:00 UTC on the 1st.
# The rotation is idempotent and self-healing, so frequent runs are safe.
#
# To disable scheduled rotation, delete this CronJob or set suspend: true.

apiVersion: batch/v1
kind: CronJob
metadata:
  name: credential-rotation
  namespace: openemr
  labels:
    app: credential-rotation
    component: security
spec:
  schedule: "0 3 1 * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  startingDeadlineSeconds: 600
  suspend: true
  jobTemplate:
    metadata:
      labels:
        app: credential-rotation
        component: security
    spec:
      backoffLimit: 0
      ttlSecondsAfterFinished: 604800
      template:
        metadata:
          labels:
            app: credential-rotation
            component: security
        spec:
          serviceAccountName: credential-rotation-sa
          restartPolicy: Never

          securityContext:
            runAsUser: 0
            runAsGroup: 0
            fsGroup: 101
            seccompProfile:
              type: RuntimeDefault

          containers:
            - name: credential-rotation
              image: "${CREDENTIAL_ROTATION_IMAGE}"
              args: ["--log-json"]

              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop: ["ALL"]
                  add: ["CHOWN", "FOWNER", "DAC_OVERRIDE"]

              env:
                - name: AWS_REGION
                  value: "${AWS_REGION}"
                - name: RDS_SLOT_SECRET_ID
                  value: "${RDS_SLOT_SECRET_ARN}"
                - name: RDS_ADMIN_SECRET_ID
                  value: "${RDS_ADMIN_SECRET_ARN}"
                - name: OPENEMR_SITES_MOUNT_ROOT
                  value: "/mnt/openemr-sites"
                - name: K8S_NAMESPACE
                  value: "openemr"
                - name: K8S_DEPLOYMENT_NAME
                  value: "openemr"
                - name: K8S_SECRET_NAME
                  value: "openemr-db-credentials"
                - name: OPENEMR_HEALTHCHECK_URL
                  value: "${OPENEMR_HEALTHCHECK_URL}"

              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 512Mi

              volumeMounts:
                - name: openemr-sites
                  mountPath: /mnt/openemr-sites
                - name: tmp
                  mountPath: /tmp

          volumes:
            - name: openemr-sites
              persistentVolumeClaim:
                claimName: openemr-sites-pvc
            - name: tmp
              emptyDir: {}

          tolerations:
            - key: "eks.amazonaws.com/compute-type"
              operator: "Equal"
              value: "auto-mode"
              effect: "NoSchedule"
