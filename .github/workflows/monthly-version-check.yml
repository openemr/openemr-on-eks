# ======================================================
# OpenEMR EKS Monthly Version Check & Awareness Workflow
# ======================================================
# This workflow provides automated version checking and awareness for all components
# in the OpenEMR EKS deployment. It runs monthly on a schedule and can be manually
# triggered to check for available updates across different component categories.
#
# Key Features:
# - Scheduled monthly execution (1st of every month at 9:00 AM UTC)
# - Manual workflow dispatch with component type selection
# - Comprehensive version checking across multiple component categories
# - Automated GitHub issue creation for update awareness
# - Detailed reporting with priority-based categorization
# - Support for different check types (applications, infrastructure, etc.)
# - Integration with version-manager.sh script for comprehensive analysis
#
# Component Categories:
# - Applications: OpenEMR, monitoring stack, etc.
# - Infrastructure: EKS, RDS
# - Terraform Modules: Infrastructure as Code components
# - GitHub Workflows: CI/CD pipeline components
# - Monitoring: Prometheus, Grafana, Loki
# - EKS Addons: Kubernetes cluster extensions
#
# Workflow Process:
# 1. Set up environment and dependencies
# 2. Run version-manager.sh with specified component type
# 3. Generate comprehensive awareness reports
# 4. Create GitHub issues for update notifications
# 5. Provide detailed summaries and recommendations

name: Version Check & Awareness

# Workflow triggers - scheduled and manual
on:
  schedule:
    # Run on the 1st of every month at 9:00 AM UTC
    - cron: '0 9 1 * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of version check'
        required: true
        default: 'all'
        type: choice
        options:
          - all               # Check all component categories
          - applications      # Application-level components
          - infrastructure    # Infrastructure components
          - terraform_modules # Terraform modules and providers
          - github_workflows  # GitHub Actions and workflows
          - monitoring        # Monitoring and observability stack
          - eks_addons        # EKS cluster add-ons
      create_issue:
        description: 'Create GitHub issue for updates'
        required: true
        default: true
        type: boolean

# Environment variables for consistent tool versions and configuration
env:
  VERSION_CHECK_ENABLED: "true"  # Enable version checking functionality
  LOG_LEVEL: INFO                # Logging level for detailed output
  TF_VERSION: "1.14.3"           # Terraform version for infrastructure checks
  KUBECTL_VERSION: "v1.35.0"     # kubectl version for Kubernetes checks

# Authentication Note:
# This repository now prefers GitHub OIDC ‚Üí AWS IAM role.
# If OIDC is not configured yet, the workflow will fall back to static AWS credentials.
# See docs/GITHUB_AWS_CREDENTIALS.md for details.

# Required permissions for version checking and issue creation
permissions:
  id-token: write       # Required for OIDC authentication (more secure than and preferred over static credentials)
  contents: read        # Read repository contents for version analysis
  issues: write         # Create GitHub issues for update notifications
  pull-requests: read   # Read pull request information
  actions: read         # Read workflow information for reporting

jobs:
  # Primary job - performs comprehensive version checking across all components
  # This job sets up the environment, runs version checks, and generates reports
  version-check:
    name: Check for Updates
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository with full history for version analysis
      - name: Checkout Repository
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0  # Fetch complete git history for comprehensive analysis

      # Step 2: Set up Terraform for infrastructure version checking
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # Step 3: Set up kubectl for Kubernetes version checking
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4.0.1
        with:
          version: ${{ env.KUBECTL_VERSION }}

      # Step 4: Install additional dependencies for version checking
      - name: Setup Dependencies
        run: |
          # Install required tools for version analysis
          sudo apt-get update
          sudo apt-get install -y curl jq  # curl for API calls, jq for JSON processing

          # Install yq for YAML processing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq


      # Step 5: Set credential environment variables for conditional logic
      # These are set as empty strings if secrets don't exist, allowing safe conditional checks
      - name: Set credential environment variables
        run: |
          echo "AWS_OIDC_ROLE_ARN=${{ secrets.AWS_OIDC_ROLE_ARN || '' }}" >> $GITHUB_ENV
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID || '' }}" >> $GITHUB_ENV

      # Step 6: Configure AWS credentials (OIDC preferred)
      # This step enables AWS API access for enhanced version checking via OIDC
      - name: Configure AWS credentials (OIDC preferred)
        if: env.AWS_OIDC_ROLE_ARN != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}
        continue-on-error: true  # Don't fail if OIDC is not configured yet

      # Step 7: Configure AWS credentials (static fallback)
      # This step falls back to static credentials if OIDC is not configured
      - name: Configure AWS credentials (static fallback)
        if: env.AWS_OIDC_ROLE_ARN == '' && env.AWS_ACCESS_KEY_ID != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}
        continue-on-error: true  # Don't fail if AWS credentials are not available

      # Step 8: Execute comprehensive version awareness check
      # This step runs the version-manager.sh script with appropriate parameters
      - name: Run Version Awareness Check
        id: version_check
        run: |
          # Initialize log file for detailed tracking
          touch scripts/version-check.log
          
          # Validate version-manager.sh script exists and is executable
          if [ ! -f "scripts/version-manager.sh" ]; then
            echo "ERROR: version-manager.sh not found" | tee scripts/version-check.log
            echo "updates_found=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          chmod +x scripts/version-manager.sh

          # Test script execution and validate dependencies
          echo "Testing script execution..." >> scripts/version-check.log
          echo "yq version: $(yq --version)" >> scripts/version-check.log
          echo "jq version: $(jq --version)" >> scripts/version-check.log
          echo "versions.yaml exists: $(test -f versions.yaml && echo 'yes' || echo 'no')" >> scripts/version-check.log
          
          # Test basic script functionality before full execution
          ./scripts/version-manager.sh status >> scripts/version-check.log 2>&1 || echo "Script status check failed" >> scripts/version-check.log

          # Determine run type and set appropriate environment variables
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual run - use timestamp for unique identification
            TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S UTC")
            REPORT_TITLE="Manual Version Check Report - $TIMESTAMP"
            echo "VERSION_CHECK_MONTH=$TIMESTAMP" >> $GITHUB_ENV
            echo "IS_MANUAL_RUN=true" >> $GITHUB_ENV
            echo "REPORT_TITLE=$REPORT_TITLE" >> $GITHUB_ENV
          else
            # Scheduled run - use month format for monthly reports
            CURRENT_MONTH=$(date +"%B %Y")
            REPORT_TITLE="Version Check Report for Month of $CURRENT_MONTH"
            echo "VERSION_CHECK_MONTH=$CURRENT_MONTH" >> $GITHUB_ENV
            echo "IS_MANUAL_RUN=false" >> $GITHUB_ENV
            echo "REPORT_TITLE=$REPORT_TITLE" >> $GITHUB_ENV
          fi

          # Execute version check based on input parameters
          echo "Running version check for: ${{ github.event.inputs.check_type || 'all' }}" >> scripts/version-check.log
          echo "Report title: $REPORT_TITLE" >> scripts/version-check.log
          
          # Run version-manager.sh with appropriate component type
          case "${{ github.event.inputs.check_type || 'all' }}" in
            "applications")
              ./scripts/version-manager.sh check --components applications --create-issue --month "$REPORT_TITLE" 2>&1 | tee -a scripts/version-check.log || echo "Script failed with exit code $?" | tee -a scripts/version-check.log
              ;;
            "infrastructure")
              ./scripts/version-manager.sh check --components infrastructure --create-issue --month "$REPORT_TITLE" 2>&1 | tee -a scripts/version-check.log || echo "Script failed with exit code $?" | tee -a scripts/version-check.log
              ;;
            "terraform_modules")
              ./scripts/version-manager.sh check --components terraform_modules --create-issue --month "$REPORT_TITLE" 2>&1 | tee -a scripts/version-check.log || echo "Script failed with exit code $?" | tee -a scripts/version-check.log
              ;;
            "github_workflows")
              ./scripts/version-manager.sh check --components github_workflows --create-issue --month "$REPORT_TITLE" 2>&1 | tee -a scripts/version-check.log || echo "Script failed with exit code $?" | tee -a scripts/version-check.log
              ;;
            "monitoring")
              ./scripts/version-manager.sh check --components monitoring --create-issue --month "$REPORT_TITLE" 2>&1 | tee -a scripts/version-check.log || echo "Script failed with exit code $?" | tee -a scripts/version-check.log
              ;;
            "eks_addons")
              ./scripts/version-manager.sh check --components eks_addons --create-issue --month "$REPORT_TITLE" 2>&1 | tee -a scripts/version-check.log || echo "Script failed with exit code $?" | tee -a scripts/version-check.log
              ;;
            *)
              # Default: check all components
              ./scripts/version-manager.sh check --create-issue --month "$REPORT_TITLE" 2>&1 | tee -a scripts/version-check.log || echo "Script failed with exit code $?" | tee -a scripts/version-check.log
              ;;
          esac

          # Prepare log files for artifact upload and report generation
          if [ -f "version-updates.log" ]; then
            cp version-updates.log scripts/version-updates.log
          fi
          
          # Copy version-check.log to root directory for report generation
          if [ -f "scripts/version-check.log" ]; then
            cp scripts/version-check.log version-check.log
          fi
          
          # Analyze log files to determine if updates were found
          if grep -q "Found.*component.*with.*available.*updates" scripts/version-check.log || grep -q "Found.*component.*with.*available.*updates" scripts/version-updates.log; then
            echo "updates_found=true" >> $GITHUB_OUTPUT
            echo "Updates found in log" | tee -a scripts/version-check.log
          else
            echo "updates_found=false" >> $GITHUB_OUTPUT
            echo "No updates found in log" | tee -a scripts/version-check.log
          fi
          
          # Ensure updates_found status is set for downstream jobs
          echo "Final updates_found status: $(grep -q "Found.*component.*with.*available.*updates" scripts/version-check.log || grep -q "Found.*component.*with.*available.*updates" scripts/version-updates.log && echo 'true' || echo 'false')" | tee -a scripts/version-check.log

      # Step 9: Upload version check logs as artifacts
      # This step preserves detailed logs for analysis and troubleshooting
      - name: Upload Version Check Logs
        uses: actions/upload-artifact@v6
        if: always()  # Upload artifacts regardless of job outcome
        with:
          name: version-check-logs-${{ github.run_number }}
          path: |
            scripts/version-check.log
            scripts/version-updates.log
          retention-days: 30  # Retain logs for 30 days
          if-no-files-found: warn

      # Step 10: Generate comprehensive version awareness report
      # This step creates detailed reports for both manual and scheduled runs
      - name: Create Version Awareness Report
        if: always()  # Generate report regardless of job outcome
        run: |
          # Generate detailed awareness report based on run type
          if [ "${{ env.IS_MANUAL_RUN }}" = "true" ]; then
            # Manual run report with timestamp-based identification
            echo "# üì¢ OpenEMR EKS Version Check Report" > update-report.md
            echo "" >> update-report.md
            echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> update-report.md
            echo "**Workflow:** [Monthly Version Check & Awareness](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> update-report.md
            echo "**Triggered by:** Manual workflow dispatch by @${{ github.actor }}" >> update-report.md
            echo "**Timestamp:** ${{ env.VERSION_CHECK_MONTH }}" >> update-report.md
            echo "" >> update-report.md
            echo "## üìã Summary" >> update-report.md
            echo "" >> update-report.md
            echo "This manual version check has identified available updates for your OpenEMR EKS deployment components. This is an **awareness notification** - no automatic updates will be applied." >> update-report.md
          else
            # Scheduled monthly report with month-based identification
            echo "# üì¢ OpenEMR EKS Monthly Version Awareness Report" > update-report.md
            echo "" >> update-report.md
            echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> update-report.md
            echo "**Workflow:** [Monthly Version Check & Awareness](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> update-report.md
            echo "**Triggered by:** Scheduled monthly check" >> update-report.md
            echo "**Month:** ${{ env.VERSION_CHECK_MONTH }}" >> update-report.md
            echo "" >> update-report.md
            echo "## üìã Summary" >> update-report.md
            echo "" >> update-report.md
            echo "This monthly automated check has identified available updates for your OpenEMR EKS deployment components. This is an **awareness notification** - no automatic updates will be applied." >> update-report.md
          fi

          echo "" >> update-report.md
          echo "## üîç Check Results" >> update-report.md
          echo "" >> update-report.md
          if [ -f "scripts/version-check.log" ] || [ -f "scripts/version-updates.log" ]; then
            # Extract only the summary section from the log
            if grep -q "Found.*component.*with.*available.*updates" scripts/version-check.log 2>/dev/null || grep -q "Found.*component.*with.*available.*updates" scripts/version-updates.log 2>/dev/null; then
              echo "### ‚úÖ Updates Available" >> update-report.md
              echo "" >> update-report.md
              
              # Create a properly formatted table
              echo "| Component | Current ‚Üí Latest | Priority |" >> update-report.md
              echo "|-----------|------------------|----------|" >> update-report.md
              
              # Extract updates and categorize by priority
              (grep -E "‚Üí [^‚ùå]" scripts/version-check.log 2>/dev/null || grep -E "‚Üí [^‚ùå]" scripts/version-updates.log 2>/dev/null) | sed 's/.*INFO\] //' | sed 's/ update available: /: /' | sed 's/ ‚Üí / ‚Üí /' | grep -v "‚Üí null" | grep -v "‚Üí ‚ùå" | grep -v "‚Üí Unable to determine" | while IFS=':' read -r component versions; do
                # Determine priority based on component type
                priority="üü° Medium"
                if [[ "$component" == *"OpenEMR"* ]] || [[ "$component" == *"Kubernetes"* ]] || [[ "$component" == *"EKS"* ]]; then
                  priority="üî¥ High"
                elif [[ "$component" == *"Terraform"* ]] || [[ "$component" == *"Prometheus"* ]] || [[ "$component" == *"Loki"* ]]; then
                  priority="üü° Medium"
                elif [[ "$component" == *"actions/"* ]] || [[ "$component" == *"commitizen"* ]]; then
                  priority="üü¢ Low"
                fi
                echo "| **$component** | \`$versions\` | $priority |" >> update-report.md
              done
              
              echo "" >> update-report.md
              echo "### üìç Quick File Reference" >> update-report.md
              echo "" >> update-report.md
              echo "> üí° **Detailed file locations with line numbers** are available in the workflow artifacts below" >> update-report.md
              
              # Add note about failed checks if any
              if grep -q "Unable to determine" scripts/version-check.log 2>/dev/null || grep -q "Unable to determine" scripts/version-updates.log 2>/dev/null; then
                echo "" >> update-report.md
                echo "### ‚ö†Ô∏è Note" >> update-report.md
                echo "Some components could not be checked due to API limitations or network issues. Check the full log for details." >> update-report.md
              fi
            else
              echo "### ‚úÖ All Components Up to Date" >> update-report.md
              echo "" >> update-report.md
              echo "No updates available at this time." >> update-report.md
            fi
          else
            echo "### ‚ùå Check Failed" >> update-report.md
            echo "" >> update-report.md
            echo "Version check could not complete. Please check the workflow logs for details." >> update-report.md
          fi
          echo "" >> update-report.md

          echo "## üìÅ Generated Reports" >> update-report.md
          echo "" >> update-report.md
          echo "- **Version Check Log:** Available in workflow artifacts" >> update-report.md
          echo "- **Detailed Report:** Available in workflow artifacts" >> update-report.md
          echo "" >> update-report.md
          echo "**How to access:** Go to the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) and scroll down to the 'Artifacts' section to download the reports." >> update-report.md
          echo "" >> update-report.md

          echo "## üöÄ Action Plan" >> update-report.md
          echo "" >> update-report.md
          echo "### üî¥ High Priority (Apply First)" >> update-report.md
          echo "- Review and test **OpenEMR**, **Kubernetes**, and **EKS** updates" >> update-report.md
          echo "- Check for breaking changes in release notes" >> update-report.md
          echo "" >> update-report.md
          echo "### üü° Medium Priority (Schedule for Next Maintenance)" >> update-report.md
          echo "- Update **Terraform**, **Prometheus**, and **Loki** components" >> update-report.md
          echo "- Test in development environment first" >> update-report.md
          echo "" >> update-report.md
          echo "### üü¢ Low Priority (When Convenient)" >> update-report.md
          echo "- Update **GitHub Actions** and **pre-commit hooks**" >> update-report.md
          echo "- These can be updated during regular development cycles" >> update-report.md
          echo "" >> update-report.md
          echo "### üîß Quick Commands" >> update-report.md
          echo "" >> update-report.md
          echo "\`\`\`bash" >> update-report.md
          echo "# Check current status" >> update-report.md
          echo "./scripts/version-dashboard.sh" >> update-report.md
          echo "" >> update-report.md
          echo "# Check specific components" >> update-report.md
          echo "./scripts/version-manager.sh check --components applications" >> update-report.md
          echo "\`\`\`" >> update-report.md
          echo "" >> update-report.md
          echo "> **Note:** All updates must be applied manually. No automatic updates will be performed." >> update-report.md
          echo "" >> update-report.md

          if [ "${{ env.IS_MANUAL_RUN }}" = "true" ]; then
            echo "---" >> update-report.md
            echo "" >> update-report.md
            echo "*This awareness report was generated automatically by the OpenEMR EKS Version Awareness system.*" >> update-report.md
          else
            echo "---" >> update-report.md
            echo "" >> update-report.md
            echo "*This monthly awareness report was generated automatically by the OpenEMR EKS Version Awareness system.*" >> update-report.md
          fi

      # Step 11: Create detailed report for artifact download
      # This step generates a comprehensive report with all version information
      - name: Create Detailed Report
        if: always()  # Generate report regardless of job outcome
        run: |
          # Generate detailed report for artifact download
          set +e  # Disable exit on error for this step
          if [ -f "scripts/version-check.log" ] || [ -f "scripts/version-updates.log" ]; then
            # Create detailed report with comprehensive information
            if [ "${{ env.IS_MANUAL_RUN }}" = "true" ]; then
              echo "# üì¢ OpenEMR EKS Version Check - Detailed Report" > detailed-report.md
              echo "" >> detailed-report.md
              echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> detailed-report.md
              echo "**Workflow:** [Monthly Version Check & Awareness](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> detailed-report.md
              echo "**Triggered by:** Manual workflow dispatch by @${{ github.actor }}" >> detailed-report.md
              echo "**Timestamp:** ${{ env.VERSION_CHECK_MONTH }}" >> detailed-report.md
            else
              echo "# üì¢ OpenEMR EKS Monthly Version Check - Detailed Report" > detailed-report.md
              echo "" >> detailed-report.md
              echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> detailed-report.md
              echo "**Workflow:** [Monthly Version Check & Awareness](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> detailed-report.md
              echo "**Triggered by:** Scheduled monthly check" >> detailed-report.md
              echo "**Month:** ${{ env.VERSION_CHECK_MONTH }}" >> detailed-report.md
            fi
            echo "" >> detailed-report.md
            echo "## üìã Summary" >> detailed-report.md
            echo "" >> detailed-report.md
            echo "This detailed report contains comprehensive information about available updates for your OpenEMR EKS deployment components." >> detailed-report.md
            echo "" >> detailed-report.md
            echo "## üîç Check Results" >> detailed-report.md
            echo "" >> detailed-report.md
            # Analyze log files for available updates
            if grep -q "Found.*component.*with.*available.*updates" scripts/version-check.log 2>/dev/null || grep -q "Found.*component.*with.*available.*updates" scripts/version-updates.log 2>/dev/null; then
              echo "### ‚úÖ Updates Available" >> detailed-report.md
              echo "" >> detailed-report.md
              echo "**Available Updates:**" >> detailed-report.md
              echo "" >> detailed-report.md
              # Extract actual version changes, filtering out null values and errors
              {
                grep -E "‚Üí [^‚ùå]" scripts/version-check.log 2>/dev/null || true
                grep -E "‚Üí [^‚ùå]" scripts/version-updates.log 2>/dev/null || true
              } | sed 's/.*INFO\] //' | sed 's/ update available: /: /' | sed 's/ ‚Üí / ‚Üí /' | grep -v "‚Üí null" | grep -v "‚Üí ‚ùå" | grep -v "‚Üí Unable to determine" >> detailed-report.md || true
              echo "" >> detailed-report.md
              echo "### üìç Version Locations" >> detailed-report.md
              echo "" >> detailed-report.md
              # Extract version locations for each component
              {
                grep -A 15 "### üìç Version Locations for" scripts/version-check.log 2>/dev/null || true
                grep -A 15 "### üìç Version Locations for" scripts/version-updates.log 2>/dev/null || true
              } | grep -v "‚Üí null" | grep -v "‚Üí ‚ùå" | grep -v "‚Üí Unable to determine" >> detailed-report.md || true
              
              # Add note about failed checks if any
              if grep -q "Unable to determine" scripts/version-check.log 2>/dev/null || grep -q "Unable to determine" scripts/version-updates.log 2>/dev/null; then
                echo "" >> detailed-report.md
                echo "### ‚ö†Ô∏è Note" >> detailed-report.md
                echo "Some components could not be checked due to API limitations or network issues. Check the full log for details." >> detailed-report.md
              fi
            else
              echo "### ‚úÖ All Components Up to Date" >> detailed-report.md
              echo "" >> detailed-report.md
              echo "No updates available at this time." >> detailed-report.md
            fi
            echo "" >> detailed-report.md
            echo "## üéØ Next Steps" >> detailed-report.md
            echo "" >> detailed-report.md
            echo "1. **Review updates** above and assess priority" >> detailed-report.md
            echo "2. **Test updates in development** before applying to production" >> detailed-report.md
            echo "3. **Check release notes** for breaking changes" >> detailed-report.md
            echo "4. **Apply updates manually** during maintenance windows" >> detailed-report.md
            echo "" >> detailed-report.md
            echo "### üîß Quick Commands" >> detailed-report.md
            echo "" >> detailed-report.md
            echo "\`\`\`bash" >> detailed-report.md
            echo "# Check current status" >> detailed-report.md
            echo "./scripts/version-dashboard.sh" >> detailed-report.md
            echo "" >> detailed-report.md
            echo "# Check specific components" >> detailed-report.md
            echo "./scripts/version-manager.sh check --components applications" >> detailed-report.md
            echo "\`\`\`" >> detailed-report.md
            echo "" >> detailed-report.md
            echo "> **Note:** All updates must be applied manually. No automatic updates will be performed." >> detailed-report.md
            echo "" >> detailed-report.md
            echo "---" >> detailed-report.md
            echo "" >> detailed-report.md
            echo "*This detailed report was generated automatically by the OpenEMR EKS Version Awareness system.*" >> detailed-report.md
          fi
          
          # Re-enable exit on error for the rest of the workflow
          set -e

      # Step 12: Upload detailed report as artifact
      - name: Upload Detailed Report
        uses: actions/upload-artifact@v6
        if: always()  # Upload regardless of job outcome
        with:
          name: detailed-version-report-${{ github.run_number }}
          path: |
            detailed-report.md
          retention-days: 30  # Retain report for 30 days
          if-no-files-found: warn

      # Step 13: Create GitHub issue for update awareness (if enabled)
      - name: Create GitHub Issue
        if: always() && (github.event_name == 'schedule' || github.event.inputs.create_issue == 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('update-report.md', 'utf8');
            const isManualRun = process.env.IS_MANUAL_RUN === 'true';
            const reportTitle = process.env.REPORT_TITLE || 'Version Check Report';
            const timestamp = process.env.VERSION_CHECK_MONTH || new Date().toISOString();

            if (isManualRun) {
              // Manual run - always create a new timestamped issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: reportTitle,
                body: report,
                labels: ['version-check', 'manual', 'maintenance', 'dependencies', 'awareness']
              });

              console.log('Created manual version check issue:', issue.data.html_url);
            } else {
              // Create new monthly issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: reportTitle,
                body: report,
                labels: ['version-check', 'automated', 'monthly', 'maintenance', 'dependencies', 'awareness']
              });

              console.log('Created monthly issue:', issue.data.html_url);
            }

  # Notification job - provides status updates and completion notifications
  # This job runs after the version-check job and provides feedback about the process
  notification:
    name: Send Notifications
    runs-on: ubuntu-24.04
    needs: version-check  # Wait for version-check job to complete
    if: always()          # Run regardless of version-check outcome

    steps:
      # Step 1: Send success notification
      - name: Notify on Success
        if: needs.version-check.result == 'success'
        run: |
          if [ "${{ env.IS_MANUAL_RUN }}" = "true" ]; then
            echo "‚úÖ Manual version check completed successfully"
            echo "Updates found and reported at ${{ env.VERSION_CHECK_MONTH }}"
          else
            echo "‚úÖ Monthly version check completed successfully"
            echo "Updates found and reported for ${{ env.VERSION_CHECK_MONTH }}"
          fi

      # Step 2: Send failure notification
      - name: Notify on Failure
        if: needs.version-check.result == 'failure'
        run: |
          if [ "${{ env.IS_MANUAL_RUN }}" = "true" ]; then
            echo "‚ùå Manual version check failed"
          else
            echo "‚ùå Monthly version check failed"
          fi
          exit 1
