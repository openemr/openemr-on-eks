# =====================================
# OpenEMR on EKS Console CI Workflow
# =====================================
# This workflow provides continuous integration (CI) for the OpenEMR on EKS Console (TUI),
# including building, testing, and linting to ensure code quality.
#
# Key Features:
# - Automatic builds on push and pull requests
# - Go code quality checks (fmt, vet, staticcheck)
# - Multi-platform builds (macOS, Linux) to verify cross-compilation
# - Security scanning with Trivy
#
# Build Matrix:
# - macOS (darwin/amd64, darwin/arm64)
# - Linux (linux/amd64)
#

name: Console CI/CD

# Workflow triggers
on:
  # Automatic triggers on console changes
  push:
    branches: [ main, develop ]
    paths:
      - 'console/**'
      - '.github/workflows/console-ci.yml'
      - 'go.mod'
      - 'go.sum'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'console/**'
      - '.github/workflows/console-ci.yml'
      - 'go.mod'
      - 'go.sum'
  # Manual trigger
  workflow_dispatch:

# Required permissions
permissions:
  contents: read          # Read repository contents
  security-events: write  # Write security scan results to GitHub Security tab
  actions: read           # Read workflow information

# Environment variables
env:
  GO_VERSION: '1.25'      # Go version required by console
  BINARY_NAME: 'openemr-eks-console'
  MODULE_PATH: 'console'

jobs:
  # Lint and format check job
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Set up Go
        uses: actions/setup-go@v6.2.0
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('console/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        working-directory: ${{ env.MODULE_PATH }}
        run: go mod download

      - name: Run go fmt check
        working-directory: ${{ env.MODULE_PATH }}
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "‚ùå Code is not formatted. Run 'go fmt ./...' to fix."
            gofmt -s -d .
            exit 1
          fi
          echo "‚úÖ Code is properly formatted"

      - name: Run go vet
        working-directory: ${{ env.MODULE_PATH }}
        run: go vet ./...

      - name: Install staticcheck
        run: go install honnef.co/go/tools/cmd/staticcheck@latest

      - name: Run staticcheck
        working-directory: ${{ env.MODULE_PATH }}
        run: staticcheck ./...

  # Build and test job
  build:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-14, macos-15]
        include:
          - os: ubuntu-24.04
            goos: linux
            goarch: amd64
            artifact_name: linux-amd64
          - os: macos-14
            goos: darwin
            goarch: amd64
            artifact_name: darwin-amd64
          - os: macos-15
            goos: darwin
            goarch: arm64
            artifact_name: darwin-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Set up Go
        uses: actions/setup-go@v6.2.0
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('console/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        working-directory: ${{ env.MODULE_PATH }}
        run: go mod download

      - name: Verify dependencies
        working-directory: ${{ env.MODULE_PATH }}
        run: go mod verify

      - name: Build console
        working-directory: ${{ env.MODULE_PATH }}
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          # Get project root (parent of console directory)
          PROJECT_ROOT="$(cd .. && pwd)"
          go build -ldflags "-X main.embeddedProjectRoot=$PROJECT_ROOT" -o ${{ env.BINARY_NAME }} main.go
          chmod +x ${{ env.BINARY_NAME }}

      - name: Test binary exists
        working-directory: ${{ env.MODULE_PATH }}
        run: |
          if [ ! -f "${{ env.BINARY_NAME }}" ]; then
            echo "‚ùå Binary not found after build"
            exit 1
          fi
          echo "‚úÖ Binary built successfully: ${{ env.BINARY_NAME }}"
          ls -lh ${{ env.BINARY_NAME }}

      - name: Verify binary is executable
        working-directory: ${{ env.MODULE_PATH }}
        run: |
          # Verify the binary is executable
          if [ -x "${{ env.BINARY_NAME }}" ]; then
            echo "‚úÖ Binary is executable"
            file ${{ env.BINARY_NAME }}
          else
            echo "‚ùå Binary is not executable"
            exit 1
          fi

      - name: Upload build artifact (for debugging)
        uses: actions/upload-artifact@v6
        if: failure()  # Only upload artifacts if build fails for debugging
        with:
          name: ${{ env.BINARY_NAME }}-${{ matrix.artifact_name }}-debug
          path: ${{ env.MODULE_PATH }}/${{ env.BINARY_NAME }}
          retention-days: 1

  # Security scanning job - ZERO-TOLERANCE policy
  security:
    name: Security Scan (Zero-Tolerance)
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Set up Go
        uses: actions/setup-go@v6.2.0
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download dependencies
        working-directory: ${{ env.MODULE_PATH }}
        run: go mod download

      # Run Trivy with table format first for readable output
      - name: Run Trivy vulnerability scanner (Table format - STRICT)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '${{ env.MODULE_PATH }}'
          format: 'table'
          output: 'trivy-results.txt'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'     # All severities - zero tolerance
          scanners: 'vuln,secret,misconfig'        # Enable all scanners
          exit-code: '1'                           # FAIL on any finding
          trivyignores: '.trivyignore'             # Use ignore file for false positives only

      # Run Trivy in SARIF format for GitHub Security tab
      - name: Run Trivy vulnerability scanner (SARIF format)
        uses: aquasecurity/trivy-action@master
        if: success()
        with:
          scan-type: 'fs'
          scan-ref: '${{ env.MODULE_PATH }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'  # All severities
          scanners: 'vuln,secret,misconfig'
          exit-code: '1'                        # FAIL on any finding
          trivyignores: '.trivyignore'

      # Display scan results
      - name: Display Trivy results
        if: always()
        run: |
          echo "üîç Trivy Security Scan Results for Console (ZERO-TOLERANCE):"
          echo "============================================================="
          if [ -f "trivy-results.txt" ]; then
            cat trivy-results.txt
          else
            echo "‚úÖ No vulnerabilities found - scan passed"
          fi
          echo "============================================================="

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true  # Don't fail if GitHub Advanced Security is not enabled
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Security scan enforcement status
        if: success()
        run: |
          echo "‚úÖ Security scan PASSED - No findings detected"
          echo "üîí Zero-tolerance policy enforced for Console"

